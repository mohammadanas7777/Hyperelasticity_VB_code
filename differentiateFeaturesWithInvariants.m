function[dQdI1,dQdI2,dQdI3]=differentiateFeaturesWithInvariants(NF,NE,I1,I3)
dQdI1 = [1./I3.^(2./3),...
    1./I3.^(1./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3))./I3.^(2./3),...
    (I1./I3.^(1./3) - 3)./I3.^(2./3) + ((I1 + I3 - 1)./I3.^(2./3) - 3)./I3.^(1./3),...
    (2.*(I1./I3.^(1./3) - 3))./I3.^(1./3),...
    (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2)./I3.^(2./3),...
    ((I1 + I3 - 1)./I3.^(2./3) - 3).^2./I3.^(1./3) + (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3))./I3.^(2./3),...
    (I1./I3.^(1./3) - 3).^2./I3.^(2./3) + (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3))./I3.^(1./3),...
    (3.*(I1./I3.^(1./3) - 3).^2)./I3.^(1./3),...
    (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3)./I3.^(2./3),...
    ((I1 + I3 - 1)./I3.^(2./3) - 3).^3./I3.^(1./3) + (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3))./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3))./I3.^(1./3) + (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^2)./I3.^(2./3),...
    (I1./I3.^(1./3) - 3).^3./I3.^(2./3) + (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^2)./I3.^(1./3),...
    (4.*(I1./I3.^(1/3) - 3).^3)./I3.^(1/3),...
    (5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4)./I3.^(2./3),...
    ((I1 + I3 - 1)./I3.^(2./3) - 3).^4./I3.^(1./3) + (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3))./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3))./I3.^(1./3) + (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^2)./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^3)./I3.^(2./3) + (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^2)./I3.^(1./3),...
    (I1./I3.^(1./3) - 3).^4./I3.^(2./3) + (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^3)./I3.^(1./3),...
    (5.*(I1./I3.^(1./3) - 3).^4)./I3.^(1./3),...
    (6.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5)./I3.^(2./3),...
    ((I1 + I3 - 1)./I3.^(2./3) - 3).^5./I3.^(1./3) + (5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*(I1./I3.^(1./3) - 3))./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*(I1./I3.^(1./3) - 3))./I3.^(1./3) + (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3).^2)./I3.^(2./3),...
    (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3).^2)./I3.^(1./3) + (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^3)./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^4)./I3.^(2./3) + (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^3)./I3.^(1./3),...
    (I1./I3.^(1./3) - 3).^5./I3.^(2./3) + (5.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^4)./I3.^(1./3),...
    (6.*(I1./I3.^(1./3) - 3).^5)./I3.^(1./3),...
    (7.*((I1 + I3 - 1)./I3.^(2./3) - 3).^6)./I3.^(2./3),...
    ((I1 + I3 - 1)./I3.^(2./3) - 3).^6./I3.^(1./3) + (6.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5.*(I1./I3.^(1./3) - 3))./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5.*(I1./I3.^(1./3) - 3))./I3.^(1./3) + (5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*(I1./I3.^(1./3) - 3).^2)./I3.^(2./3),...
    (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*(I1./I3.^(1./3) - 3).^2)./I3.^(1./3) + (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3).^3)./I3.^(2./3),...
    (4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3).^3)./I3.^(1./3) + (3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^4)./I3.^(2./3),...
    (2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^5)./I3.^(2./3) + (5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^4)./I3.^(1./3),...
    (I1./I3.^(1./3) - 3).^6./I3.^(2./3) + (6.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^5)./I3.^(1./3),...
    (7.*(I1./I3.^(1./3) - 3).^6)./I3.^(1./3),...
    0.*I1,...
    0.*I1,...
    0.*I1,...
    0.*I1,...
    0.*I1,...
    0.*I1,...
    0.*I1,...
    1./(I1 + I3 - 1)];

dQdI2=zeros(NE,NF);

dQdI3 =[1./I3.^(2./3) - (2.*(I1 + I3 - 1))./(3.*I3.^(5./3)),...
    -I1./(3.*I3.^(4./3)),...
    -2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)),...
    - ((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3) - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3))./(3.*I3.^(4./3)),...
    -(2.*I1.*(I1./I3.^(1./3) - 3))./(3.*I3.^(4./3)),...
    -3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)),...
    - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2)./(3.*I3.^(4./3)) - 2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3),...
    - ((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^2 - (2.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3))./(3.*I3.^(4./3)),...
    -(I1.*(I1./I3.^(1./3) - 3).^2)./I3.^(4./3),...
    -4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)),...
    - 3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3) - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3)./(3.*I3.^(4./3)),...
    - 2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^2 - (2.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3))./(3.*I3.^(4./3)),...
    - ((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^3 - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^2)./I3.^(4./3),...
    -(4.*I1.*(I1./I3.^(1./3) - 3).^3)./(3.*I3.^(4./3)),...
    -5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)),...
    - 4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3) - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4)./(3.*I3.^(4./3)),...
    - 3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^2 - (2.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3))./(3.*I3.^(4./3)),...
    - 2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^3 - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^2)./I3.^(4./3),...
    - ((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^4 - (4.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^3)./(3.*I3.^(4./3)),...
    -(5.*I1.*(I1./I3.^(1./3) - 3).^4)./(3.*I3.^(4./3)),...
    -6.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)),...
    - 5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3) - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5)./(3.*I3.^(4./3)),...
    - 4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^2 - (2.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*(I1./I3.^(1./3) - 3))./(3.*I3.^(4./3)),...
    - 3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^3 - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3).^2)./I3.^(4./3),...
    - 2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^4 - (4.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^3)./(3.*I3.^(4./3)),...
    - ((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^5 - (5.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^4)./(3.*I3.^(4./3)),...
    -(2.*I1.*(I1./I3.^(1./3) - 3).^5)./I3.^(4./3),...
    -7.*((I1 + I3 - 1)./I3.^(2./3) - 3).^6.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)),...
    - 6.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3) - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^6)./(3.*I3.^(4./3)),...
    - 5.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^2 - (2.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^5.*(I1./I3.^(1./3) - 3))./(3.*I3.^(4./3)),...
    - 4.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^3 - (I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^4.*(I1./I3.^(1./3) - 3).^2)./I3.^(4./3),...
    - 3.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^4 - (4.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^3.*(I1./I3.^(1./3) - 3).^3)./(3.*I3.^(4./3)),...
    - 2.*((I1 + I3 - 1)./I3.^(2./3) - 3).*((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^5 - (5.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).^2.*(I1./I3.^(1./3) - 3).^4)./(3.*I3.^(4./3)),...
    - ((2.*(I1 + I3 - 1))./(3.*I3.^(5./3)) - 1./I3.^(2./3)).*(I1./I3.^(1./3) - 3).^6 - (2.*I1.*((I1 + I3 - 1)./I3.^(2./3) - 3).*(I1./I3.^(1./3) - 3).^5)./I3.^(4./3),...
    -(7.*I1.*(I1./I3.^(1./3) - 3).^6)./(3.*I3.^(4./3)),...
    (I3.^(1./2) - 1)./I3.^(1./2),...
    (2.*(I3.^(1./2) - 1).^3)./I3.^(1./2),...
    (3.*(I3.^(1./2) - 1).^5)./I3.^(1./2),...
    (4.*(I3.^(1./2) - 1).^7)./I3.^(1./2),...
    (5.*(I3.^(1./2) - 1).^9)./I3.^(1./2),...
    (6.*(I3.^(1./2) - 1).^11)./I3.^(1./2),...
    (7.*(I3.^(1./2) - 1).^13)./I3.^(1./2),...
    -(3.*I3.^(2./3).*((2.*(I1 + I3 - 1))./(9.*I3.^(5./3)) - 1./(3.*I3.^(2./3))))./(I1 + I3 - 1)];

end